# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении
Товар
```
export interface IProduct {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number;
};
```

Тип для данных карточки товара
```
export type TProductCard = IProduct & {
    itemIndex?: number;
};
```

Список товаров (ответ сервера)
```
export interface IProductList {
    total: number;
    items: IProduct[];
};
```

Тип для метода оплаты
```
export type TPaymentMethod = 'card' | 'cash' | '';
```

Данные пользователя
```
export interface IUser {
    paymentMethod: TPaymentMethod;
    address: string;
    email: string;
    phone: string;
};
```

Интерфейс для хранения данных карточек
```
export interface IProductsData {
    products: IProduct[];
    preview: string | null;
    getProduct(id: string): IProduct | undefined;
};
```

Интерфейс управления данными пользователя
```
export interface IUserData {
    setOrderInfo(data: TUserOrderInfo): void;
    setContactsInfo(data: TUserContactInfo): void;
    isOrderValid(data: Record<keyof TUserOrderInfo, string>): { isValid: boolean, errors: string };
    isContactsValid(data: Record<keyof TUserContactInfo, string>): { isValid: boolean, errors: string };
}
```

Интерфейс управления корзиной
```
export interface IProductsCartData {
    products: IProduct[];
    addProduct(product: IProduct): void;
    deleteProduct(id: string): void;
    getProduct(id: string): IProduct | undefined;
    getTotalPrice(): number;
}
```

Карточка товара в каталоге
```
export type TProductCardInfo = Pick<IProduct,  'image' | 'title' | 'category' | 'price'>;
```

Карточка товара в попапе
```
export type TProductModalInfo = Pick<IProduct, 'description' | 'image' | 'title' | 'category' | 'price'>;
```

Карточка товара в корзине
```
export type TProductCartInfo = Pick<IProduct, 'title' | 'price'>;
```

Данные пользователя на первом шаге оформления заказа
```
export type TUserOrderInfo = Pick<IUserInfo, 'paymentMethod' | 'address'>;
```

Данные пользователя на втором шаге оформления заказа
```
export type TUserContactInfo = Pick<IUserInfo, 'email' | 'phone'>;
```

Методы для запроса на сервер(не считая get)
```
export type ApiPostMethods = 'POST';
```

Интерфейс для работы с Api
```
export interface IApi {
    baseUrl: string;
    get<T>(url: string): Promise<T>;
    post<T>(url: string, data: object, method?: ApiPostMethods): Promise<T>;
}
```

## Архитектура приложения
Код приложения разделён на слои согласно парадигме MVP:
 - слой предсавления, отвечающий за отображение данных на странице
 - слой данных, отвечающий за хранение и изменение данных
 - презентер, отвечающий за связь между слоями

### Базовый код

#### Класс API
Содержит в себе базовую логику отправки и обработки запросов. При создании в него передаётся базовый адрес сервера с которым будет происходить обмен запросами и `объект с заголовками запросов (необязательно)`. Методы:

- `get` - выполняет GET запрос по переданному энд поинту и возвращает промис с ответом.
- `post` - принимает в себя объект с данными и выполняет POST `метод может быть переопределён третьим параметром` запрос по переданному энд поинту. Внутри тела запроса находится переданный объект.

#### Класс EventEmitter
Брокер событий, может вызывать события, а также позволяет подписываться на них. Используется в презентере для обработки событий, а в слоях для создания этих событий. Методы:
 - `on` - подписка на событие
 - `off` - снятие подписки на событие
 - `onAll` - подписка на все события
 - `offAll` - снятие подписки на все события
 - `emit` - инициализация события
 - `trigger` - возвращает функцию, при вызове которой инициализируется переданное в параметрах событие.

### Слой данных

#### Класс Catalog
Класс отвечает за храненеи и логику работы с данными товаров полученных с сервера.\
Констркутор принимает экземпляр брокера событий.\
Поля класса:
 - `_products: IProduct[]` - массив товаров.
 - `_preview: string | null` - ID товара, выбранного для раскрытия модального окна.
 - `events: IEvents` - экземпляр класса `EventEmitter` для инициализации событий при изменении данных.
 Так же класс предоставляет методы для взаимодействия с данными:
 - `getProduct` - возвращает товар по его ID
 - а также сеттеры и геттеры полей

 Реализует интерфейс:
```
export interface IProductsData {
    products: IProduct[];
    preview: string | null;
    getProduct(id: string): IProduct | undefined;
};
```

#### Класс User
Класс отвечает за храненеи и логику работы с данными пользователя.\
Поля класса:
 - `user: IUser` - объект данных пользователя.
 Так же класс предоставляет методы для взаимодействия с данными:
 - `isPaymentMethod` - тайпгард для метода оплаты
 - `setOrderInfo` - устанавливает данные пользователя об оплате (способ и адрес) 
 - `setContactsInfo` - устанавливает данные пользователя о контактах (телефон и почта)
 - `clearUserData` - метод для очистки данных пользователя
 - `isOrderValid` - проверяет объект с данными об оплате на валидность
 - `isContactsValid` - проверяет объект с данными о контактах на валидность
 - а также геттеры и сеттеры полей объекта данных пользователя, и геттер самого объекта пользователя

 Реализует интерфейс:
```
export interface IUserData {
    setOrderInfo(data: TUserOrderInfo): void;
    setContactsInfo(data: TUserContactInfo): void;
    isOrderValid(data: Record<keyof TUserOrderInfo, string>): { isValid: boolean, errors: string };
    isContactsValid(data: Record<keyof TUserContactInfo, string>): { isValid: boolean, errors: string };
}
```

#### Класс Cart
Класс отвечает за храненеи и логику работы с данными товаров в корзине.\
Констркутор принимает экземпляр брокера событий.\
Поля класса:
 - `_products: IProduct[]` - массив товаров.
 - `events: IEvents` - экземпляр класса `EventEmitter` для инициализации событий при изменении данных.
 Так же класс предоставляет методы для взаимодействия с данными:
 - `addProduct` - добавляет товар в конец массива. Также вызывает событие добавления товара.
 - `deleteProduct` - удаляет товар по его ID. Также вызывает событие удаления товара.
 - `getProduct` - возвращает товар по его ID
 - `getTotalPrice` - возвращает общую стоимость всех товаров
 - а также геттер поля класса

 Реализует интерфейс:
```
export interface IProductsCartData {
    products: IProduct[];
    addProduct(product: IProduct): void;
    deleteProduct(id: string): void;
    getProduct(id: string): IProduct | undefined;
    getTotalPrice(): number;
}
```

### Слой представления

#### Базовый класс Component
Класс является дженериком и родителем всех компонентов в слое представления. В дженериках принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных данных в полях компонента через сеттеры, возвращает обновлённый контейнер компонента.

#### Класс Modal
Реализует универсальное модальное окно, которое при создании принимает в себя элемент модального окна и брокер событий. Устанавливает слушатели на крестик, клик вне модального окна и клавиатуру для закрытия модального окна.\
Поля класса:
- `container: HTMLElement` - элемент модального окна
- `events: IEvents` - экземпляр класса `EventEmitter` для инициализации событий при изменении данных

Также содержит в себе следующие методы:
- `open` - открывает модальное окно по текущему селектору и инициализирует событие об открытии попапа
- `close` - закрывает модальное окно по текущему селектору и инициализирует событие о закрытии попапа
- `handleEsc` - проверяет, является ли нажатая кнопка верной для закрытия модального окна
- `render` - принимает в себя разметку после чего меняет содержимое окна и возвращает его разметку

#### Класс Modal
Реализует универсальный объект формы, которая при создании принимает в себя элемент формы и брокер событий. Устанавливает слушатели на ввод, нажатие кнопок и сабмит формы.\
Поля класса:
- `container: HTMLElement` - элемент формы
- `events: IEvents` - экземпляр класса `EventEmitter` для инициализации событий при изменении данных
- `optionButtons: NodeListOf<HTMLButtonElement>` - список кнопок выбора варианта в форме
- `submitButton: HTMLButtonElement` - кнопка отправки формы
- `errorText: HTMLElement` - текст для отображения ошибок в форме

Также содержит в себе следующие методы:
- `clearForm` - метод для очистки данных формы
- `isButtonIsOption` - проверяет, является ли кнопка кнопкой выбора варианта
- `onInputChange` - инициирует событие при вводе в поля формы
- `render` - принимает в себя разметку после чего меняет содержимое окна и возвращает его разметку
- геттеры и сеттеры полей класса

#### Класс Card
Отвечает за отображение карточки товара, задавая ей все данные. В конструктор передаётся брокер событий для инициализации событий и элемент содержимого темплейта, что позволяет при необходимости формировать карточки разных вариантов вёрстки. В классе устанавливаются слушатели на интерактивные элементы карточки.\
В полях класса находятся элементы разметки карточки, а также ID товара.
Методы:
- `render(data?: Partial<TProductCard>)` - заполняет данные карточки и возвращает разметку карточки с установленными слушателями
- `setAddButtonState(state: boolean)` - метод устанавливает состояние кнопки добваления товара в корзину в соответствии с переданным состоянием
- `deleteCard()` - метод удаляет карточку из DOM, а также очищает данные элемента карточки
- а также сеттеры элементов карточки *(и геттер у id карточки)*

#### Класс CardsContainer
Класс, отвечающий за отображение коллекции карточек товара на главной странице. В конструктор принимает контейнер для карточек. В метод render принимает массив разметки карточек, который отображает в контейнере.

#### Класс Cart
Класс, отвечающий за отображение коллекции карточек товара в корзине. В конструктор принимает элемент корзины и брокер событий. В метод render принимает массив разметки карточек, который отображает в контейнере.\

### Слой коммуникации

#### Класс AppApi
В конструкоре класс принимает экземпляр класса Api и предоставляет методы для взаимодействия с бэкендом.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`. Он выполняет роль презентера.\
Всё взаимодействие осуществляется за счёт событий генерируемых брокером событий и обработчиков этих событий, описанных в `index.ts`.\
В `index.ts` сперва создаются экземпляры всех нужных классов, а потом настраивается обработка событий.

*Список всех событий в системе:*\
События данных:
- `CATALOG:CHANGED` - изменение массива товаров в каталоге
- `CART:CHANGED` - изменение массива товаров в корзине
- `CARD:SELECTED` - изменение карточки для попапа

События представления:
- `MODAL:OPEN` - открытие модального окна
- `MODAL:CLOSE` - модального окна
- `CARD:SELECT` - выбор карточки в каталоге
- `CARD:ADD` - добавление товара в корзину
- `CARD:DELETE` - удаление товара из корзины
- `CART_OPEN` = открытие попапа корзины
- `CART:ORDER` - оформление заказа в корзине
- `ORDER-PAYMENT:INPUT` - изменение метода оплаты
- `ORDER-ADDRESS:INPUT` - изменение адреса доставки
- `ORDER:VALIDATION` - событие, для валидации формы заказа
- `ORDER:SUBMIT` - переход к заполнению контактов
- `CONTACTS-EMAIL:INPUT` - изменение e-mail
- `CONTACTS-PHONE:INPUT` - изменение номера телефона
- `CONTACTS:VALIDATION` - событие, для валидации формы контактов
- `CONTACTS:SUBMIT` - отправка заказа
- `SUCCESS:CLOSE` - закрытие попапа успешного заказа